@model JPFData.ViewModels.TransactionViewModel

@{
    ViewBag.Title = "Index";
}


<div class="content">
    <div class="container-fluid">
        <div class="row">
            <div class="col-md-12">
                <div class="card">
                    <div class="header">
                        <h4 class="title">Transactions</h4>
                        <p class="category">Last 30 Days</p>
                    </div>
                    <div class="content">
                        <div id="chartExpenses" class="ct-chart"></div>
                        <div class="footer">
                            <div class="chart-legend">
                                <i class="fa fa-circle text-success"></i> Total
                                <i class="fa fa-circle text-info"></i> Income
                                <i class="fa fa-circle text-danger"></i> Expense
                            </div>
                            <hr />
                            <div class="stats">
                                <i class="ti-reload"></i> Updated 3 minutes ago
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-md-12">
                <div class="card">
                    <div class="header">
                        <h4 class="title">Transactions</h4>
                    </div>
                    <div class="content">
                        @using (Html.BeginForm())
                        {
                            <p>
                                @Html.ActionLink("Create New", "Create")
                            </p>
                            <table class="table">
                                <tr>
                                    <th>
                                        @Html.DisplayNameFor(model => model.Entity.Transaction.Date)
                                    </th>
                                    <th>
                                        @Html.DisplayNameFor(model => model.Entity.Transaction.Payee)
                                    </th>
                                    <th>
                                        @Html.DisplayNameFor(model => model.Entity.Transaction.Memo)
                                    </th>
                                    <th>
                                        @Html.DisplayNameFor(model => model.Entity.Transaction.Type)
                                    </th>
                                    <th>
                                        @Html.DisplayNameFor(model => model.Entity.Transaction.Category)
                                    </th>
                                    <th>
                                        @Html.DisplayNameFor(model => model.Entity.Transaction.Amount)
                                    </th>
                                    <th></th>
                                </tr>

                                @foreach (var item in Model.Entity.Transactions.OrderByDescending(m => m.Date))
                                {
                                    <tr>
                                        <td>
                                            @Html.DisplayFor(modelItem => item.Date)
                                        </td>
                                        <td>
                                            @Html.DisplayFor(modelItem => item.Payee)
                                        </td>
                                        <td>
                                            @Html.DisplayFor(modelItem => item.Memo)
                                        </td>
                                        <td>
                                            @Html.DisplayFor(modelItem => item.Type)
                                        </td>
                                        <td>
                                            @Html.DisplayFor(modelItem => item.Category)
                                        </td>
                                        <td>
                                            @Html.DisplayFor(modelItem => item.Amount)
                                        </td>
                                        <td>
                                            @Html.ActionLink("Edit", "Edit", new { id = item.Id }) |
                                         @*   @Html.ActionLink("Details", "Details", new { id = item.Id }) |*@
                                            @Html.ActionLink("Delete", "Delete", new { id = item.Id })
                                        </td>
                                    </tr>
                                }
                            </table>
                        }
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section scripts {
    <!--   Core JS Files   -->
    <script src="../../Scripts/jquery-1.10.2.js" type="text/javascript"></script>
    <script src="../../Scripts/bootstrap-paper.min.js" type="text/javascript"></script>

    <!--  Charts Plugin -->
    <script src="../../Scripts/chartist.min.js"></script>
    <script type="text/javascript" src="https://www.google.com/jsapi"></script> ;
    <script>
        google.load("visualization",
            "1",
            {
                packages: ["corechart"]
            });

        $(document).ready(function() { chart(); });

        function chart() {
            var metrics = @Html.Raw(Json.Encode(@Model.Entity.Metrics));
            var mandatoryExpensesByMonth = metrics.MandatoryExpensesByMonth;
            var discretionaryExpensesByMonth = metrics.DiscretionaryExpensesByMonth;
            var expensesByMonth = metrics.ExpensesByMonth;
            var incomeByMonth = metrics.IncomeByMonth;
            var transfersByMonth = metrics.TransfersByMonth;

            var expensesLength = Object.keys(expensesByMonth).length;
            var mandatoryLength = Object.keys(mandatoryExpensesByMonth).length;
            var discretionaryLength = Object.keys(discretionaryExpensesByMonth).length;
            var incomeLength = Object.keys(incomeByMonth).length;
            var transferLength = Object.keys(transfersByMonth).length;

            var monthsArray = new Array(expensesLength);
            var expensesArray = new Array(expensesLength);
            var mandatoryArray = new Array(mandatoryLength);
            var discretionaryArray = new Array(discretionaryLength);
            var incomeArray = new Array(incomeLength);
            var transferArray = new Array(transferLength);
            var highestAmount = 0;

            for (prop in expensesByMonth) {
                monthsArray.push(prop);
                expensesArray.push(expensesByMonth[prop]);
                if (expensesByMonth[prop] > highestAmount) {
                    highestAmount = expensesByMonth[prop];
                }
            }

            for (prop in mandatoryExpensesByMonth) {
                mandatoryArray.push(mandatoryExpensesByMonth[prop]);
                if (mandatoryExpensesByMonth[prop] > highestAmount) {
                    highestAmount = mandatoryExpensesByMonth[prop];
                }
            }

            for (prop in discretionaryExpensesByMonth) {
                discretionaryArray.push(discretionaryExpensesByMonth[prop]);
                if (discretionaryExpensesByMonth[prop] > highestAmount) {
                    highestAmount = discretionaryExpensesByMonth[prop];
                }
            }

            for (prop in expensesByMonth) {
                incomeArray.push(expensesByMonth[prop]);
                if (expensesByMonth[prop] > highestAmount) {
                    highestAmount = expensesByMonth[prop];
                }
            }

            for (prop in transfersByMonth) {
                transferArray.push(transfersByMonth[prop]);
                if (transfersByMonth[prop] > highestAmount) {
                    highestAmount = transfersByMonth[prop];
                }
            }

            monthsArray = monthsArray.filter(function(n) { return n != undefined });
            expensesArray = expensesArray.filter(function(n) { return n != undefined });
            mandatoryArray = mandatoryArray.filter(function(n) { return n != undefined });
            discretionaryArray = discretionaryArray.filter(function(n) { return n != undefined });
            incomeArray = incomeArray.filter(function(n) { return n != undefined });
            transferArray = transferArray.filter(function(n) { return n != undefined });

            var dataTable = new google.visualization.DataTable();

            var data = [['Month', 'Total Expenses', 'Discretionary', 'Mandatory', 'Income', 'Transfers']];

            for (var i = 0; i <= monthsArray.length; i++) {
                data.push([monthsArray[i], expensesArray[i], discretionaryArray[i], mandatoryArray[i], incomeArray[i], transferArray[i]]);
            };

            var numRows = data.length;
            var numCols = data[0].length;

            dataTable.addColumn('string', data[0][0]);

            for (var i = 1; i < numCols; i++)
                dataTable.addColumn('number', data[0][1]);

            for (var i = 1; i < numRows; i++)
                dataTable.addRow(data[i]);

            var options = {
                width: "auto",
                pointSize: 7,
                lineWidth: 1,
                height: "200",
                backgroundColor: "transparent",
                colors: ["#EB5E28", "#F3BB45", "#F3BB45", "#F7CC89", "#F2BC11"],
                tooltip: {
                    textStyle: {
                        color: "#666666",
                        fontSize: 11
                    },
                    showColorCode: false
                },
                legend: {
                    textStyle: {
                        color: "black",
                        fontSize: 12
                    }
                },
                chartArea: {
                    left: 40,
                    top: 10,
                    height: "80%"
                }
            };

            var chart = new google.visualization.AreaChart(document.getElementById("chartExpenses"));
            chart.draw(dataTable, options);
        }
    </script>
}
